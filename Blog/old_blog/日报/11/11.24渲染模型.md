# SSR 的“文章渲染管线”具体指什么（详细分解）

“渲染管线”就是请求到 HTML 输出这条链路上的各个步骤与处理逻辑。SSR 的文章渲染管线通常包含如下阶段（我把每一环节都写清楚，你可以把它逐步实现或观察）：

1. **请求（Request）进入服务端**
   - 接收 HTTP 请求（如 `/posts/2025-11-24-example`），包括 headers、cookies、accept-language 等。
   - 在 Edge / Server / Node 环境（取决于部署）启动渲染流程。
2. **路由解析（Routing）**
   - 根据 URL 找到对应的路由处理器（Server Route / Page Component）。
   - 在 Next.js 中，App Router 的 server component 会先执行 server-side 逻辑。
3. **数据获取（Data Fetching）**
   - 从内容来源读取数据：通常是读取 Markdown 文件 + frontmatter（title、date、tags、summary、slug、draft 等）。
   - 可以同时从索引（search index）、外部 API 或数据库拉取额外数据（阅读统计、推荐列表）。
   - 关键点：在 SSR 场景中，数据获取是同步/异步挂起点（必须处理超时、失败、缓存）。
4. **Markdown 解析与扩展处理（Parsing & Transform）**
   - **Markdown → AST（remark）**
     - 解析成语法树（mdast）。
   - **语法树转化（remark 插件链）**
     - 代码高亮（rehype-prism/rehype-shiki）
     - 表格、脚注、脚注编号、TOC（目录）、图片处理（responsive srcset）
     - 自定义组件解析（MDX, 把 `<MyComponent />` 转化为可渲染组件）
   - **AST → HTML（rehype）**
     - 最终生成 HTML 字符串或 React/VNode（如果用 MDX 则是 React tree）。
5. **组件渲染 / SSR 渲染（Component Rendering）**
   - 如果使用 React（Next.js），把解析后的内容嵌入 Page 的 JSX 中，由 React 在服务端渲染成 HTML 字符串。
   - 注意区分：完全 server component（不需要水合） vs client component（需要水合脚本）。
6. **注入页面元数据（Head / SEO）**
   - 动态填充 `<title>`、meta description、open graph、结构化数据（JSON-LD）、canonical、sitemap entry 等。
   - 这对 SEO 和社媒预览很关键。
7. **性能优化步骤（服务端）**
   - **缓存策略**：对文章页面采用 CDN 缓存或 server-side 缓存（例如 `Cache-Control: public, max-age=...` 或使用 Redis 缓存渲染结果）。
   - **流式渲染（Streaming）**：在 React 18+ 支持下，可以开启 SSR streaming，先发送 shell，再发送内容片段，提高感知速度。
   - **并发/批量数据拉取**：把多个数据请求并行化，降低延迟。
8. **静态资源与预加载（Link / Preload）**
   - 在渲染的 HTML 中合理插入 `<link rel="preload">`、prefetch、preconnect 等，优化首次渲染。
   - 图片使用响应式 `srcset`、占位图（LQIP）或 modern image optimization（Next/Image 或自定义）。
9. **返回（Response）并在边缘/CDN 缓存**
   - 将 HTML 返回给客户端，CDN（如 Cloudflare、Vercel、Netlify）可以缓存页面并处理后续请求。
   - 对于需要“即时更新”的页面，触发 revalidation 或直接失效缓存。
10. **客户端水合（Hydration）**（如果页面包含可交互组件）
    - 将 JS bundle 下发，客户端对必要组件进行水合（hydrate），并添加交互行为（例如目录滚动、高亮、代码复制按钮等）。
11. **监控与观测（Observability）**
    - 记录渲染时间、95% 延迟、错误率（Sentry/Log），分析瓶颈并优化。

> 你可以把这个管线当作一个流水线项目，每一阶段都可以单独拆成模块来实现/测试/优化（比如先做 Markdown → HTML，再把它嵌入到 SSR 渲染中）。